<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local="clr-namespace:UltimateVideoBrowser.Views"
             x:Class="UltimateVideoBrowser.Views.MainPage"
             BackgroundColor="{DynamicResource AppBg}"
             Title="Videos">

    <Grid RowDefinitions="Auto,Auto,*">
        <!-- Top bar -->
        <Grid Padding="12" ColumnDefinitions="*,Auto,Auto" BackgroundColor="{DynamicResource Surface}">
            <Label Text="Ultimate Video Browser"
                   FontAttributes="Bold"
                   FontSize="16"
                   TextColor="{DynamicResource OnSurface}" />
            <Button Grid.Column="1"
                    Text="Sources"
                    Command="{Binding OpenSourcesCommand}"
                    BackgroundColor="{DynamicResource Surface2}"
                    TextColor="{DynamicResource OnSurface}"
                    CornerRadius="10"
                    Padding="12,8" />
            <Button Grid.Column="2"
                    Text="Reindex"
                    Command="{Binding RunIndexCommand}"
                    BackgroundColor="{DynamicResource Accent}"
                    TextColor="{DynamicResource OnAccent}"
                    CornerRadius="10"
                    Padding="12,8"
                    Margin="8,0,0,0" />
        </Grid>

        <!-- Search + Sort -->
        <Grid Grid.Row="1" Padding="12" ColumnDefinitions="*,Auto" BackgroundColor="{DynamicResource AppBg}">
            <SearchBar Placeholder="Search videos..."
                       Text="{Binding SearchText}"
                       SearchCommand="{Binding RefreshCommand}"
                       BackgroundColor="{DynamicResource Surface2}"
                       TextColor="{DynamicResource OnSurface}"
                       PlaceholderColor="{DynamicResource OnSurfaceMuted}" />
            <Picker Grid.Column="1"
                    ItemsSource="{Binding SortOptions}"
                    SelectedItem="{Binding SortKey}"
                    Title="Sort"
                    TextColor="{DynamicResource OnSurface}"
                    BackgroundColor="{DynamicResource Surface2}"
                    Margin="8,0,0,0" />
        </Grid>

        <!-- Grid -->
        <Grid Grid.Row="2">
            <CollectionView ItemsSource="{Binding Videos}"
                            x:Name="VideosView"
                            SelectionMode="None">
                <CollectionView.ItemsLayout>
                    <GridItemsLayout Orientation="Vertical" Span="{Binding GridSpan}" />
                </CollectionView.ItemsLayout>

                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame BackgroundColor="{DynamicResource Surface}"
                               CornerRadius="14"
                               Margin="8"
                               Padding="0"
                               HasShadow="False">
                            <Grid RowDefinitions="160,Auto,Auto" Padding="8">
                                <Grid RowDefinitions="*" BackgroundColor="{DynamicResource Surface2}"
                                      HeightRequest="160">
                                    <Image Source="{Binding ThumbnailPath}"
                                           Aspect="AspectFill" />
                                </Grid>

                                <Label Grid.Row="1"
                                       Text="{Binding Name}"
                                       TextColor="{DynamicResource OnSurface}"
                                       FontSize="13"
                                       LineBreakMode="TailTruncation"
                                       Margin="0,8,0,0" />

                                <Label Grid.Row="2"
                                       Text="{Binding DurationText}"
                                       TextColor="{DynamicResource OnSurfaceMuted}"
                                       FontSize="11"
                                       Margin="0,2,0,0" />

                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.PlayCommand}"
                                        CommandParameter="{Binding .}" />
                                </Grid.GestureRecognizers>
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- Indexing overlay -->
            <Grid IsVisible="{Binding IsIndexing}"
                  BackgroundColor="#99000000"
                  Padding="24">
                <Frame BackgroundColor="{DynamicResource Surface}"
                       CornerRadius="16"
                       Padding="16"
                       HorizontalOptions="Center"
                       VerticalOptions="Center"
                       HasShadow="False">
                    <VerticalStackLayout Spacing="10">
                        <Label Text="Indexing..."
                               FontAttributes="Bold"
                               TextColor="{DynamicResource OnSurface}" />
                        <Label Text="{Binding IndexedCount, StringFormat='New items: {0}'}"
                               TextColor="{DynamicResource OnSurfaceMuted}" />
                        <ActivityIndicator IsRunning="True" />
                    </VerticalStackLayout>
                </Frame>
            </Grid>
        </Grid>
    </Grid>
</ContentPage>
