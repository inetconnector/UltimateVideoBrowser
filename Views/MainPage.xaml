<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local="clr-namespace:UltimateVideoBrowser.Views"
             xmlns:strings="clr-namespace:UltimateVideoBrowser.Resources.Strings"
             x:Class="UltimateVideoBrowser.Views.MainPage"
             BackgroundColor="{DynamicResource AppBg}"
             Title="{x:Static strings:AppResources.MainPageTitle}">

    <Grid RowDefinitions="Auto,Auto,Auto,*">
        <!-- Top bar -->
        <Grid Padding="12" ColumnDefinitions="*,Auto,Auto" BackgroundColor="{DynamicResource Surface}">
            <Label Text="{x:Static strings:AppResources.AppTitle}"
                   FontAttributes="Bold"
                   FontSize="16"
                   TextColor="{DynamicResource OnSurface}" />
            <Button Grid.Column="1"
                    Text="{x:Static strings:AppResources.SourcesButton}"
                    Command="{Binding OpenSourcesCommand}"
                    BackgroundColor="{DynamicResource Surface2}"
                    TextColor="{DynamicResource OnSurface}"
                    CornerRadius="10"
                    Padding="12,8" />
            <Button Grid.Column="2"
                    Text="{x:Static strings:AppResources.ReindexButton}"
                    Command="{Binding RunIndexCommand}"
                    BackgroundColor="{DynamicResource Accent}"
                    TextColor="{DynamicResource OnAccent}"
                    CornerRadius="10"
                    Padding="12,8"
                    Margin="8,0,0,0" />
        </Grid>

        <!-- Permission notice -->
        <Grid Grid.Row="1"
              Padding="12"
              IsVisible="{Binding HasMediaPermission, Converter={StaticResource InverseBoolConverter}}">
            <Frame BackgroundColor="{DynamicResource Surface}"
                   CornerRadius="12"
                   Padding="12"
                   HasShadow="False">
                <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                    <VerticalStackLayout Spacing="4">
                        <Label Text="{x:Static strings:AppResources.PermissionTitle}"
                               FontAttributes="Bold"
                               TextColor="{DynamicResource OnSurface}" />
                        <Label Text="{x:Static strings:AppResources.PermissionMessage}"
                               TextColor="{DynamicResource OnSurfaceMuted}"
                               FontSize="12" />
                    </VerticalStackLayout>
                    <Button Grid.Column="1"
                            Text="{x:Static strings:AppResources.PermissionOk}"
                            Command="{Binding RequestPermissionCommand}"
                            BackgroundColor="{DynamicResource Accent}"
                            TextColor="{DynamicResource OnAccent}"
                            CornerRadius="10"
                            Padding="12,8" />
                </Grid>
            </Frame>
        </Grid>

        <!-- Search + Sort -->
        <Grid Grid.Row="2" Padding="12" ColumnDefinitions="*,Auto" BackgroundColor="{DynamicResource AppBg}">
            <SearchBar Placeholder="{x:Static strings:AppResources.SearchPlaceholder}"
                       Text="{Binding SearchText}"
                       SearchCommand="{Binding RefreshCommand}"
                       BackgroundColor="{DynamicResource Surface2}"
                       TextColor="{DynamicResource OnSurface}"
                       PlaceholderColor="{DynamicResource OnSurfaceMuted}" />
            <Picker Grid.Column="1"
                    ItemsSource="{Binding SortOptions}"
                    ItemDisplayBinding="{Binding Display}"
                    SelectedItem="{Binding SelectedSortOption}"
                    Title="{x:Static strings:AppResources.SortTitle}"
                    TextColor="{DynamicResource OnSurface}"
                    BackgroundColor="{DynamicResource Surface2}"
                    Margin="8,0,0,0" />
        </Grid>

        <!-- Grid -->
        <Grid Grid.Row="3">
            <CollectionView ItemsSource="{Binding Videos}"
                            x:Name="VideosView"
                            SelectionMode="None">
                <CollectionView.ItemsLayout>
                    <GridItemsLayout Orientation="Vertical" Span="{Binding GridSpan}" />
                </CollectionView.ItemsLayout>

                <CollectionView.EmptyView>
                    <VerticalStackLayout Spacing="12"
                                         HorizontalOptions="Center"
                                         VerticalOptions="Center"
                                         Margin="24">
                        <Image Source="empty-state.svg"
                               HeightRequest="180"
                               WidthRequest="240"
                               HorizontalOptions="Center" />
                        <Label Text="{x:Static strings:AppResources.EmptyStateTitle}"
                               FontAttributes="Bold"
                               FontSize="16"
                               TextColor="{DynamicResource OnSurface}"
                               HorizontalTextAlignment="Center" />
                        <Label Text="{x:Static strings:AppResources.EmptyStateMessage}"
                               FontSize="13"
                               TextColor="{DynamicResource OnSurfaceMuted}"
                               HorizontalTextAlignment="Center" />
                    </VerticalStackLayout>
                </CollectionView.EmptyView>

                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame BackgroundColor="{DynamicResource Surface}"
                               CornerRadius="14"
                               Margin="8"
                               Padding="0"
                               HasShadow="False">
                            <Grid RowDefinitions="160,Auto,Auto" Padding="8">
                                <Grid RowDefinitions="*" BackgroundColor="{DynamicResource Surface2}"
                                      HeightRequest="160">
                                    <Image Source="{Binding ThumbnailPath, Converter={StaticResource StringFallbackConverter}, ConverterParameter=video-placeholder.svg}"
                                           Aspect="AspectFill" />
                                </Grid>

                                <Label Grid.Row="1"
                                       Text="{Binding Name}"
                                       TextColor="{DynamicResource OnSurface}"
                                       FontSize="13"
                                       LineBreakMode="TailTruncation"
                                       Margin="0,8,0,0" />

                                <Label Grid.Row="2"
                                       Text="{Binding DurationText}"
                                       TextColor="{DynamicResource OnSurfaceMuted}"
                                       FontSize="11"
                                       Margin="0,2,0,0" />

                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.PlayCommand}"
                                        CommandParameter="{Binding .}" />
                                </Grid.GestureRecognizers>
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- Indexing overlay -->
            <Grid IsVisible="{Binding IsIndexing}"
                  BackgroundColor="#99000000"
                  Padding="24">
                <Frame BackgroundColor="{DynamicResource Surface}"
                       CornerRadius="16"
                       Padding="16"
                       HorizontalOptions="Center"
                       VerticalOptions="Center"
                       HasShadow="False">
                    <VerticalStackLayout Spacing="10">
                        <Label Text="{x:Static strings:AppResources.Indexing}"
                               FontAttributes="Bold"
                               TextColor="{DynamicResource OnSurface}" />
                        <Label Text="{Binding IndexStatus}"
                               TextColor="{DynamicResource OnSurfaceMuted}" />
                        <Label Text="{Binding IndexedCount, StringFormat={x:Static strings:AppResources.NewItemsFormat}}"
                               TextColor="{DynamicResource OnSurfaceMuted}" />
                        <ProgressBar Progress="{Binding IndexRatio}" />
                    </VerticalStackLayout>
                </Frame>
            </Grid>
        </Grid>
    </Grid>
</ContentPage>
