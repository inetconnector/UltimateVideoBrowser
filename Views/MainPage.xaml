<?xml version="1.0" encoding="utf-8"?>

<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:strings="clr-namespace:UltimateVideoBrowser.Resources.Strings"
             xmlns:models="clr-namespace:UltimateVideoBrowser.Models;assembly=UltimateVideoBrowser"
             xmlns:components="clr-namespace:UltimateVideoBrowser.Views.Components"
             xmlns:behaviors="clr-namespace:UltimateVideoBrowser.Behaviors"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:Class="UltimateVideoBrowser.Views.MainPage"
             x:Name="ThisPage"
             BackgroundColor="{DynamicResource AppBg}"
             Title="{x:Static strings:AppResources.MainPageTitle}">

    <Grid RowDefinitions="*,Auto">
        <!-- Browser grid -->
        <Grid Grid.Row="0"
              x:Name="BrowserGrid"
              ColumnDefinitions="120,*"
              RowDefinitions="*"
              ColumnSpacing="0"
              VerticalOptions="FillAndExpand"
              HorizontalOptions="FillAndExpand">

            <VisualStateManager.VisualStateGroups>
                <VisualStateGroup x:Name="LayoutStates">
                    <VisualState x:Name="Phone">
                        <VisualState.StateTriggers>
                            <OnIdiom x:TypeArguments="StateTriggerBase">
                                <OnIdiom.Phone>
                                    <StateTrigger IsActive="True" />
                                </OnIdiom.Phone>
                                <OnIdiom.Default>
                                    <StateTrigger IsActive="False" />
                                </OnIdiom.Default>
                            </OnIdiom>
                        </VisualState.StateTriggers>
                        <VisualState.Setters>
                            <Setter TargetName="BrowserGrid" Property="RowDefinitions" Value="*" />
                            <Setter TargetName="BrowserGrid" Property="ColumnDefinitions" Value="120,*" />

                            <!-- Sidebar LEFT -->
                            <Setter TargetName="TimelineSidebar" Property="Grid.Row" Value="0" />
                            <Setter TargetName="TimelineSidebar" Property="Grid.Column" Value="0" />
                            <Setter TargetName="TimelineSidebar" Property="Margin" Value="8,0,8,0" />

                            <!-- Media list RIGHT -->
                            <Setter TargetName="MediaItemsHost" Property="Grid.Row" Value="0" />
                            <Setter TargetName="MediaItemsHost" Property="Grid.Column" Value="1" />
                        </VisualState.Setters>
                    </VisualState>

                    <VisualState x:Name="Wide">
                        <VisualState.StateTriggers>
                            <OnIdiom x:TypeArguments="StateTriggerBase">
                                <OnIdiom.Tablet>
                                    <StateTrigger IsActive="True" />
                                </OnIdiom.Tablet>
                                <OnIdiom.Desktop>
                                    <StateTrigger IsActive="True" />
                                </OnIdiom.Desktop>
                                <OnIdiom.TV>
                                    <StateTrigger IsActive="True" />
                                </OnIdiom.TV>
                                <OnIdiom.Default>
                                    <StateTrigger IsActive="False" />
                                </OnIdiom.Default>
                            </OnIdiom>
                        </VisualState.StateTriggers>
                        <VisualState.Setters>
                            <Setter TargetName="BrowserGrid" Property="ColumnDefinitions" Value="120,*" />
                            <Setter TargetName="BrowserGrid" Property="RowDefinitions" Value="*" />

                            <!-- Sidebar LEFT -->
                            <Setter TargetName="TimelineSidebar" Property="Grid.Row" Value="0" />
                            <Setter TargetName="TimelineSidebar" Property="Grid.Column" Value="0" />
                            <Setter TargetName="TimelineSidebar" Property="Margin" Value="8,0,8,0" />

                            <!-- Media list RIGHT -->
                            <Setter TargetName="MediaItemsHost" Property="Grid.Row" Value="0" />
                            <Setter TargetName="MediaItemsHost" Property="Grid.Column" Value="1" />
                        </VisualState.Setters>
                    </VisualState>
                </VisualStateGroup>
            </VisualStateManager.VisualStateGroups>

            <!-- Sidebar: NOW LEFT -->
            <components:MainTimelineSidebarView Grid.Column="0"
                                                x:Name="TimelineSidebar"
                                                TimelineSelectionChanged="OnTimelineSelectionChanged"
                                                TimelineScrollUpClicked="OnTimelineScrollUpClicked"
                                                TimelineScrollDownClicked="OnTimelineScrollDownClicked"
                                                TimelineScrollTopClicked="OnTimelineScrollTopClicked"
                                                TimelineScrollBottomClicked="OnTimelineScrollBottomClicked"
                                                MediaScrollTopClicked="OnMediaScrollTopClicked"
                                                MediaScrollBottomClicked="OnMediaScrollBottomClicked"
                                                SettingsClicked="OnSettingsClicked"
                                                VerticalOptions="FillAndExpand"
                                                HorizontalOptions="FillAndExpand"
                                                ZIndex="1" />

            <!-- Timeline preview badge: keep on media area (RIGHT), aligned to End -->
            <Grid Grid.Column="1"
                  InputTransparent="True"
                  ZIndex="2">
                <Frame Padding="10,6"
                       CornerRadius="12"
                       BackgroundColor="{DynamicResource SurfaceElevated}"
                       BorderColor="{DynamicResource BorderSubtle}"
                       HasShadow="True"
                       HorizontalOptions="End"
                       VerticalOptions="Center"
                       Margin="0,0,16,0"
                       IsVisible="{Binding IsTimelinePreviewVisible}">
                    <Label Text="{Binding TimelinePreviewLabel}"
                           FontAttributes="Bold"
                           FontSize="12"
                           TextColor="{DynamicResource OnSurface}" />
                </Frame>
            </Grid>

            <!-- Media area: NOW RIGHT (Grid.Column=1) -->
            <Grid x:Name="MediaItemsHost"
                  Grid.Column="1"
                  ZIndex="0">

                <CollectionView
                    ItemsSource="{Binding MediaItems}"
                    x:Name="MediaItemsView"
                    SelectionMode="{OnPlatform WinUI=Multiple, Default=None}"
                    SelectionChanged="OnMediaItemsSelectionChanged"
                    RemainingItemsThreshold="12"
                    RemainingItemsThresholdReachedCommand="{Binding LoadMoreCommand}"
                    VerticalScrollBarVisibility="Always"
                    Margin="0"
                    Scrolled="OnMediaItemsScrolled"
                    VerticalOptions="FillAndExpand"
                    HorizontalOptions="FillAndExpand"
                    ItemSizingStrategy="MeasureFirstItem"
                    ItemsUpdatingScrollMode="KeepScrollOffset">
                    <CollectionView.Behaviors>
                        <behaviors:WindowsPinnedScrollBarBehavior />
                    </CollectionView.Behaviors>

                    <CollectionView.Header>
                        <Grid x:Name="HeaderContainer"
                              RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto"
                              BackgroundColor="{DynamicResource AppBg}"
                              BindingContext="{Binding Source={x:Reference ThisPage}, Path=BindingContext}">

                            <components:MainHeaderView />
                            <components:MainHeroView Grid.Row="1" />
                            <components:MainHighlightsView Grid.Row="2" />

                            <Grid Grid.Row="3"
                                  Padding="12"
                                  IsVisible="False">
                                <Frame BackgroundColor="{DynamicResource Surface}"
                                       CornerRadius="16"
                                       Padding="12"
                                       BorderColor="{DynamicResource BorderSubtle}">
                                    <VerticalStackLayout Spacing="8">
                                        <Label Text="{x:Static strings:AppResources.PreviewTitle}"
                                               FontAttributes="Bold"
                                               TextColor="{DynamicResource OnSurface}" />
                                        <Grid HeightRequest="220"
                                              BackgroundColor="{DynamicResource Surface2}">
                                            <toolkit:MediaElement Source="{Binding CurrentMediaSource}"
                                                                  ShouldAutoPlay="True"
                                                                  ShouldShowPlaybackControls="True"
                                                                  Aspect="AspectFit"
                                                                  IsVisible="{Binding ShowVideoPlayer}" />
                                            <Image Source="{Binding CurrentMediaSource}"
                                                   Aspect="AspectFit"
                                                   IsVisible="{Binding ShowPhotoPreview}" />
                                            <VerticalStackLayout IsVisible="{Binding ShowDocumentPreview}"
                                                                 HorizontalOptions="Center"
                                                                 VerticalOptions="Center"
                                                                 Spacing="6">
                                                <Image Source="chip_collection.svg"
                                                       HeightRequest="48"
                                                       WidthRequest="48" />
                                                <Label Text="{Binding CurrentMediaName}"
                                                       FontSize="12"
                                                       TextColor="{DynamicResource OnSurface}" />
                                            </VerticalStackLayout>
                                            <Label Text="{x:Static strings:AppResources.PreviewEmptyMessage}"
                                                   TextColor="{DynamicResource OnSurfaceMuted}"
                                                   HorizontalTextAlignment="Center"
                                                   VerticalTextAlignment="Center"
                                                   IsVisible="{Binding ShowPreview, Converter={StaticResource InverseBoolConverter}}" />
                                            <Grid.GestureRecognizers>
                                                <TapGestureRecognizer NumberOfTapsRequired="2"
                                                                      Command="{Binding TogglePlayerFullscreenCommand}" />
                                            </Grid.GestureRecognizers>
                                        </Grid>
                                        <Label Text="{Binding CurrentMediaName}"
                                               FontSize="12"
                                               TextColor="{DynamicResource OnSurfaceMuted}"
                                               LineBreakMode="TailTruncation"
                                               IsVisible="{Binding ShowPreview}" />
                                    </VerticalStackLayout>
                                </Frame>
                            </Grid>

                            <components:MainPermissionNoticeView Grid.Row="4" />

                            <Frame Grid.Row="5"
                                   Grid.RowSpan="5"
                                   BackgroundColor="{DynamicResource Surface}"
                                   CornerRadius="16"
                                   Padding="12"
                                   BorderColor="{DynamicResource BorderSubtle}">
                                <Grid RowDefinitions="Auto,*" RowSpacing="8">
                                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                        <Label Text="{x:Static strings:AppResources.SettingsFilterTitle}"
                                               FontAttributes="Bold"
                                               TextColor="{DynamicResource OnSurface}"
                                               VerticalOptions="Center" />

                                        <Grid Grid.Column="1" ColumnDefinitions="Auto,Auto" ColumnSpacing="6">
                                            <Button Text="▼"
                                                    WidthRequest="40"
                                                    HeightRequest="32"
                                                    Padding="0"
                                                    FontAttributes="Bold"
                                                    Style="{StaticResource OverlayButtonStyle}"
                                                    IsVisible="{Binding IsFiltersDockExpanded}"
                                                    Command="{Binding ToggleFiltersDockExpandedCommand}"
                                                    AutomationProperties.Name="Collapse filters" />
                                            <Button Text="◀"
                                                    Grid.Column="1"
                                                    WidthRequest="40"
                                                    HeightRequest="32"
                                                    Padding="0"
                                                    FontAttributes="Bold"
                                                    Style="{StaticResource OverlayButtonStyle}"
                                                    IsVisible="{Binding IsFiltersDockExpanded, Converter={StaticResource InverseBoolConverter}}"
                                                    Command="{Binding ToggleFiltersDockExpandedCommand}"
                                                    AutomationProperties.Name="Expand filters" />
                                        </Grid>
                                    </Grid>

                                    <VerticalStackLayout Grid.Row="1"
                                                         Spacing="12"
                                                         IsVisible="{Binding IsFiltersDockExpanded}">
                                        <components:MainSearchSortView x:Name="SearchSortView" />
                                        <components:MainMediaTypeFilterView />
                                        <components:MainDateFilterView IsVisible="{Binding IsDateFilterEnabled}" />
                                        <components:MainSourcesTabsView IsVisible="{Binding HasMultipleSources}" />
                                        <components:MainAlbumsTabsView IsVisible="{Binding HasAlbums}" />
                                    </VerticalStackLayout>
                                </Grid>
                            </Frame>

                            <components:MainIndexingBannerView Grid.Row="10" />
                        </Grid>
                    </CollectionView.Header>

                    <CollectionView.ItemsLayout>
                        <GridItemsLayout Orientation="Vertical"
                                         Span="{Binding GridSpan}" />
                    </CollectionView.ItemsLayout>

                    <!-- IMPORTANT: only ONE ItemTemplate, platform-specific here -->
                    <CollectionView.ItemTemplate>
                        <OnPlatform x:TypeArguments="DataTemplate">

                            <!-- Default fallback (no swipe) -->
                            <On Platform="Default">
                                <DataTemplate x:DataType="models:MediaItem">
                                    <Frame BackgroundColor="{DynamicResource Surface}"
                                           CornerRadius="16"
                                           Margin="6"
                                           Padding="0"
                                           BorderColor="{DynamicResource BorderSubtle}"
                                           MinimumWidthRequest="210"
                                           MinimumHeightRequest="200">
                                        <Frame.Triggers>
                                            <DataTrigger TargetType="Frame" Binding="{Binding IsMarked}" Value="True">
                                                <Setter Property="BorderColor" Value="{DynamicResource Accent}" />
                                                <Setter Property="BackgroundColor" Value="{DynamicResource Surface2}" />
                                            </DataTrigger>
                                        </Frame.Triggers>

                                        <Grid RowDefinitions="150,Auto" Padding="10">
                                            <Grid>
                                                <components:MediaItemPreviewView HeightRequest="150" />

                                                <Frame BackgroundColor="{DynamicResource Surface2}"
                                                       BorderColor="{DynamicResource BorderSubtle}"
                                                       CornerRadius="10"
                                                       Padding="8,4"
                                                       Margin="8"
                                                       HorizontalOptions="Start"
                                                       VerticalOptions="Start"
                                                       HasShadow="False"
                                                       IsVisible="{Binding HasDuration}">
                                                    <HorizontalStackLayout Spacing="6">
                                                        <Image Source="chip_clock.svg" HeightRequest="12"
                                                               WidthRequest="12" />
                                                        <Label Text="{Binding DurationText}"
                                                               TextColor="{DynamicResource OnSurfaceMuted}"
                                                               FontSize="11" />
                                                    </HorizontalStackLayout>
                                                </Frame>
                                            </Grid>

                                            <VerticalStackLayout Grid.Row="1"
                                                                 Spacing="2"
                                                                 Margin="0,8,0,0">
                                                <Label Text="{Binding Name}"
                                                       TextColor="{DynamicResource OnSurface}"
                                                       FontSize="12"
                                                       LineBreakMode="TailTruncation"
                                                       MaxLines="1" />
                                                <Label Text="{Binding DateAddedText}"
                                                       TextColor="{DynamicResource OnSurfaceMuted}"
                                                       FontSize="10"
                                                       LineBreakMode="TailTruncation"
                                                       MaxLines="1"
                                                       IsVisible="{Binding HasDateAdded}" />
                                            </VerticalStackLayout>
                                        </Grid>

                                        <Frame.GestureRecognizers>
                                            <TapGestureRecognizer
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.PlayCommand}"
                                                CommandParameter="{Binding .}" />
                                        </Frame.GestureRecognizers>
                                    </Frame>
                                </DataTemplate>
                            </On>

                            <!-- Android: swipe -> Share -->
                            <On Platform="Android">
                                <DataTemplate x:DataType="models:MediaItem">
                                    <SwipeView>
                                        <SwipeView.RightItems>
                                            <SwipeItems Mode="Reveal">
                                                <SwipeItem Text="{x:Static strings:AppResources.ShareAction}"
                                                           Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ShareCommand}"
                                                           CommandParameter="{Binding .}" />
                                            </SwipeItems>
                                        </SwipeView.RightItems>

                                        <Frame BackgroundColor="{DynamicResource Surface}"
                                               CornerRadius="16"
                                               Margin="6"
                                               Padding="0"
                                               BorderColor="{DynamicResource BorderSubtle}"
                                               MinimumWidthRequest="210"
                                               MinimumHeightRequest="200">
                                            <Frame.Triggers>
                                                <DataTrigger TargetType="Frame" Binding="{Binding IsMarked}"
                                                             Value="True">
                                                    <Setter Property="BorderColor" Value="{DynamicResource Accent}" />
                                                    <Setter Property="BackgroundColor"
                                                            Value="{DynamicResource Surface2}" />
                                                </DataTrigger>
                                            </Frame.Triggers>

                                            <Frame.Behaviors>
                                                <toolkit:TouchBehavior
                                                    LongPressCommand="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.OpenItemMenuCommand}"
                                                    LongPressCommandParameter="{Binding .}" />
                                            </Frame.Behaviors>

                                            <Grid RowDefinitions="150,Auto" Padding="10">
                                                <Grid>
                                                    <components:MediaItemPreviewView HeightRequest="150" />
                                                    <Frame BackgroundColor="{DynamicResource Surface2}"
                                                           BorderColor="{DynamicResource BorderSubtle}"
                                                           CornerRadius="10"
                                                           Padding="8,4"
                                                           Margin="8"
                                                           HorizontalOptions="Start"
                                                           VerticalOptions="Start"
                                                           HasShadow="False"
                                                           IsVisible="{Binding HasDuration}">
                                                        <HorizontalStackLayout Spacing="6">
                                                            <Image Source="chip_clock.svg" HeightRequest="12"
                                                                   WidthRequest="12" />
                                                            <Label Text="{Binding DurationText}"
                                                                   TextColor="{DynamicResource OnSurfaceMuted}"
                                                                   FontSize="11" />
                                                        </HorizontalStackLayout>
                                                    </Frame>
                                                </Grid>

                                                <VerticalStackLayout Grid.Row="1"
                                                                     Spacing="2"
                                                                     Margin="0,8,0,0">
                                                    <Label Text="{Binding Name}"
                                                           TextColor="{DynamicResource OnSurface}"
                                                           FontSize="12"
                                                           LineBreakMode="TailTruncation"
                                                           MaxLines="1" />
                                                    <Label Text="{Binding DateAddedText}"
                                                           TextColor="{DynamicResource OnSurfaceMuted}"
                                                           FontSize="10"
                                                           LineBreakMode="TailTruncation"
                                                           MaxLines="1"
                                                           IsVisible="{Binding HasDateAdded}" />
                                                </VerticalStackLayout>
                                            </Grid>

                                            <Frame.GestureRecognizers>
                                                <TapGestureRecognizer
                                                    NumberOfTapsRequired="2"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.PlayCommand}"
                                                    CommandParameter="{Binding .}" />
                                            </Frame.GestureRecognizers>
                                        </Frame>
                                    </SwipeView>
                                </DataTemplate>
                            </On>

                            <!-- WinUI: swipe -> Save As -->
                            <On Platform="WinUI">
                                <DataTemplate x:DataType="models:MediaItem">
                                    <SwipeView>
                                        <SwipeView.RightItems>
                                            <SwipeItems Mode="Reveal">
                                                <SwipeItem Text="{x:Static strings:AppResources.SaveAsAction}"
                                                           Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SaveAsCommand}"
                                                           CommandParameter="{Binding .}" />
                                            </SwipeItems>
                                        </SwipeView.RightItems>

                                        <Frame BackgroundColor="{DynamicResource Surface}"
                                               CornerRadius="16"
                                               Margin="6"
                                               Padding="0"
                                               BorderColor="{DynamicResource BorderSubtle}"
                                               MinimumWidthRequest="210"
                                               MinimumHeightRequest="200">
                                            <Frame.Triggers>
                                                <DataTrigger TargetType="Frame" Binding="{Binding IsMarked}"
                                                             Value="True">
                                                    <Setter Property="BorderColor" Value="{DynamicResource Accent}" />
                                                    <Setter Property="BackgroundColor"
                                                            Value="{DynamicResource Surface2}" />
                                                </DataTrigger>
                                            </Frame.Triggers>

                                            <Frame.Behaviors>
                                                <behaviors:MediaItemContextMenuBehavior
                                                    HostCollectionView="{x:Reference MediaItemsView}" />
                                            </Frame.Behaviors>

                                            <Grid RowDefinitions="150,Auto" Padding="10">
                                                <Grid>
                                                    <components:MediaItemPreviewView HeightRequest="150" />
                                                    <Frame BackgroundColor="{DynamicResource Surface2}"
                                                           BorderColor="{DynamicResource BorderSubtle}"
                                                           CornerRadius="10"
                                                           Padding="8,4"
                                                           Margin="8"
                                                           HorizontalOptions="Start"
                                                           VerticalOptions="Start"
                                                           HasShadow="False"
                                                           IsVisible="{Binding HasDuration}">
                                                        <HorizontalStackLayout Spacing="6">
                                                            <Image Source="chip_clock.svg" HeightRequest="12"
                                                                   WidthRequest="12" />
                                                            <Label Text="{Binding DurationText}"
                                                                   TextColor="{DynamicResource OnSurfaceMuted}"
                                                                   FontSize="11" />
                                                        </HorizontalStackLayout>
                                                    </Frame>
                                                </Grid>

                                                <VerticalStackLayout Grid.Row="1"
                                                                     Spacing="2"
                                                                     Margin="0,8,0,0">
                                                    <Label Text="{Binding Name}"
                                                           TextColor="{DynamicResource OnSurface}"
                                                           FontSize="12"
                                                           LineBreakMode="TailTruncation"
                                                           MaxLines="1" />
                                                    <Label Text="{Binding DateAddedText}"
                                                           TextColor="{DynamicResource OnSurfaceMuted}"
                                                           FontSize="10"
                                                           LineBreakMode="TailTruncation"
                                                           MaxLines="1"
                                                           IsVisible="{Binding HasDateAdded}" />
                                                </VerticalStackLayout>
                                            </Grid>

                                            <Frame.GestureRecognizers>
                                                <TapGestureRecognizer
                                                    NumberOfTapsRequired="2"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.PlayCommand}"
                                                    CommandParameter="{Binding .}" />
                                            </Frame.GestureRecognizers>
                                        </Frame>
                                    </SwipeView>
                                </DataTemplate>
                            </On>

                        </OnPlatform>
                    </CollectionView.ItemTemplate>

                </CollectionView>

            </Grid>

            <!-- WinUI: marquee (drag) selection overlay (over media area only) -->
            <GraphicsView Grid.Column="1"
                          x:Name="MarqueeOverlay"
                          InputTransparent="True"
                          IsVisible="False"
                          ZIndex="4"
                          HorizontalOptions="FillAndExpand"
                          VerticalOptions="FillAndExpand" />

            <!-- Empty state overlay (over media area only) -->
            <Grid Grid.Column="1"
                  Padding="24"
                  InputTransparent="True"
                  IsVisible="{Binding IsEmptyStateVisible}"
                  ZIndex="5"
                  VerticalOptions="FillAndExpand"
                  HorizontalOptions="FillAndExpand">
                <VerticalStackLayout Spacing="12"
                                     HorizontalOptions="Center"
                                     VerticalOptions="End">
                    <Image Source="empty_state.svg"
                           HeightRequest="180"
                           WidthRequest="240"
                           HorizontalOptions="Center" />
                    <Label Text="{x:Static strings:AppResources.EmptyStateTitle}"
                           FontAttributes="Bold"
                           FontSize="16"
                           TextColor="{DynamicResource OnSurface}"
                           HorizontalTextAlignment="Center" />
                    <Label Text="{x:Static strings:AppResources.EmptyStateMessage}"
                           FontSize="13"
                           TextColor="{DynamicResource OnSurfaceMuted}"
                           HorizontalTextAlignment="Center" />
                </VerticalStackLayout>
            </Grid>

        </Grid>

        <Grid Grid.RowSpan="2"
              BackgroundColor="{DynamicResource OverlayScrim}"
              IsVisible="{Binding IsPlayerFullscreen}">
            <Grid RowDefinitions="*,Auto"
                  Padding="24">
                <Frame BackgroundColor="{DynamicResource Surface}"
                       CornerRadius="18"
                       Padding="12"
                       BorderColor="{DynamicResource BorderSubtle}">
                    <toolkit:MediaElement Source="{Binding CurrentMediaSource}"
                                          ShouldAutoPlay="True"
                                          ShouldShowPlaybackControls="True"
                                          Aspect="AspectFit" />
                </Frame>
                <Label Grid.Row="1"
                       Text="{Binding CurrentMediaName}"
                       FontSize="12"
                       TextColor="{DynamicResource OnSurfaceMuted}"
                       HorizontalTextAlignment="Center"
                       Margin="0,12,0,0" />
            </Grid>
            <Grid.GestureRecognizers>
                <TapGestureRecognizer NumberOfTapsRequired="2"
                                      Command="{Binding TogglePlayerFullscreenCommand}" />
            </Grid.GestureRecognizers>
        </Grid>

        <!-- Bottom dock (preview + marked actions) -->
        <Grid Grid.Row="1"
              Padding="12"
              BackgroundColor="{DynamicResource AppBg}"
              IsVisible="{Binding ShowBottomDock}">
            <VerticalStackLayout Spacing="12">

                <Frame BackgroundColor="{DynamicResource Surface}"
                       CornerRadius="16"
                       Padding="12"
                       BorderColor="{DynamicResource BorderSubtle}"
                       IsVisible="{Binding IsInternalPlayerEnabled}">
                    <Grid RowDefinitions="Auto,*" RowSpacing="8">
                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                            <Label Text="{x:Static strings:AppResources.PreviewTitle}"
                                   FontAttributes="Bold"
                                   TextColor="{DynamicResource OnSurface}"
                                   VerticalOptions="Center" />

                            <Grid Grid.Column="1" ColumnDefinitions="Auto,Auto" ColumnSpacing="6">
                                <Button Text="▼"
                                        WidthRequest="40"
                                        HeightRequest="32"
                                        Padding="0"
                                        FontAttributes="Bold"
                                        Style="{StaticResource OverlayButtonStyle}"
                                        IsVisible="{Binding IsPreviewDockExpanded}"
                                        Command="{Binding TogglePreviewDockExpandedCommand}"
                                        AutomationProperties.Name="Collapse preview" />
                                <Button Text="▲"
                                        Grid.Column="1"
                                        WidthRequest="40"
                                        HeightRequest="32"
                                        Padding="0"
                                        FontAttributes="Bold"
                                        Style="{StaticResource OverlayButtonStyle}"
                                        IsVisible="{Binding IsPreviewDockExpanded, Converter={StaticResource InverseBoolConverter}}"
                                        Command="{Binding TogglePreviewDockExpandedCommand}"
                                        AutomationProperties.Name="Expand preview" />
                            </Grid>
                        </Grid>

                        <VerticalStackLayout Grid.Row="1" Spacing="8" IsVisible="{Binding IsPreviewDockExpanded}">
                            <Grid HeightRequest="220"
                                  BackgroundColor="{DynamicResource Surface2}">
                                <toolkit:MediaElement Source="{Binding CurrentMediaSource}"
                                                      ShouldAutoPlay="True"
                                                      ShouldShowPlaybackControls="True"
                                                      Aspect="AspectFit"
                                                      IsVisible="{Binding ShowVideoPlayer}" />
                                <Image Source="{Binding CurrentMediaSource}"
                                       Aspect="AspectFit"
                                       IsVisible="{Binding ShowPhotoPreview}" />
                                <VerticalStackLayout IsVisible="{Binding ShowDocumentPreview}"
                                                     HorizontalOptions="Center"
                                                     VerticalOptions="Center"
                                                     Spacing="6">
                                    <Image Source="chip_collection.svg"
                                           HeightRequest="48"
                                           WidthRequest="48" />
                                    <Label Text="{Binding CurrentMediaName}"
                                           FontSize="12"
                                           TextColor="{DynamicResource OnSurface}" />
                                </VerticalStackLayout>
                                <Label Text="{x:Static strings:AppResources.PreviewEmptyMessage}"
                                       TextColor="{DynamicResource OnSurfaceMuted}"
                                       HorizontalTextAlignment="Center"
                                       VerticalTextAlignment="Center"
                                       IsVisible="{Binding ShowPreview, Converter={StaticResource InverseBoolConverter}}" />
                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer NumberOfTapsRequired="2"
                                                          Command="{Binding TogglePlayerFullscreenCommand}" />
                                </Grid.GestureRecognizers>
                            </Grid>
                            <Label Text="{Binding CurrentMediaName}"
                                   FontSize="12"
                                   TextColor="{DynamicResource OnSurfaceMuted}"
                                   LineBreakMode="TailTruncation"
                                   IsVisible="{Binding ShowPreview}" />
                        </VerticalStackLayout>
                    </Grid>
                </Frame>

                <Frame BackgroundColor="{DynamicResource Surface}"
                       CornerRadius="12"
                       BorderColor="{DynamicResource BorderSubtle}"
                       Padding="12"
                       HasShadow="False"
                       IsVisible="{Binding HasMarked}">
                    <Grid ColumnDefinitions="*,Auto,Auto,Auto,Auto,Auto,Auto"
                          ColumnSpacing="8">
                        <Label
                            Text="{Binding MarkedCount, StringFormat={x:Static strings:AppResources.MarkedCountFormat}}"
                            FontAttributes="Bold"
                            TextColor="{DynamicResource OnSurface}" />
                        <Button Grid.Column="1"
                                Text="{x:Static strings:AppResources.SaveAsAction}"
                                Command="{Binding SaveAsMarkedCommand}" />
                        <Button Grid.Column="2"
                                Text="{x:Static strings:AppResources.AddToAlbumAction}"
                                Command="{Binding AddMarkedToAlbumCommand}" />
                        <Button Grid.Column="3"
                                Text="{x:Static strings:AppResources.CopyMarkedAction}"
                                IsVisible="{Binding AllowFileChanges}"
                                Command="{Binding CopyMarkedCommand}" />
                        <Button Grid.Column="4"
                                Text="{x:Static strings:AppResources.MoveMarkedAction}"
                                IsVisible="{Binding AllowFileChanges}"
                                Command="{Binding MoveMarkedCommand}" />
                        <Button Grid.Column="5"
                                Text="{x:Static strings:AppResources.DeleteMarkedAction}"
                                IsVisible="{Binding AllowFileChanges}"
                                Command="{Binding DeleteMarkedCommand}" />
                        <Button Grid.Column="6"
                                Text="{x:Static strings:AppResources.ClearMarkedAction}"
                                Command="{Binding ClearMarkedCommand}" />
                    </Grid>
                </Frame>

            </VerticalStackLayout>
        </Grid>

    </Grid>
</ContentPage>
