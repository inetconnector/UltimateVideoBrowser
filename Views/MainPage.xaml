<?xml version="1.0" encoding="utf-8"?>

<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:controls="clr-namespace:UltimateVideoBrowser.Views.Controls"
             xmlns:strings="clr-namespace:UltimateVideoBrowser.Resources.Strings"
             x:Class="UltimateVideoBrowser.Views.MainPage"
             BackgroundColor="{DynamicResource AppBg}"
             Title="{x:Static strings:AppResources.MainPageTitle}">

    <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto,*">
        <!-- Top bar -->
        <Grid Padding="16,14" ColumnDefinitions="*,Auto,Auto,Auto" BackgroundColor="{DynamicResource Surface}">
            <HorizontalStackLayout Spacing="12" VerticalOptions="Center">
                <Frame Padding="6"
                       BackgroundColor="{DynamicResource Surface2}"
                       CornerRadius="12"
                       BorderColor="{DynamicResource BorderSubtle}"
                       HeightRequest="40"
                       WidthRequest="40"
                       HorizontalOptions="Start">
                    <Image Source="app_logo.svg"
                           HeightRequest="24"
                           WidthRequest="24"
                           HorizontalOptions="Center"
                           VerticalOptions="Center" />
                </Frame>
                <VerticalStackLayout Spacing="2">
                    <Label Text="{x:Static strings:AppResources.AppTitle}"
                           FontAttributes="Bold"
                           FontSize="18"
                           TextColor="{DynamicResource OnSurface}" />
                    <Label Text="{x:Static strings:AppResources.MainPageTitle}"
                           FontSize="12"
                           TextColor="{DynamicResource OnSurfaceMuted}" />
                </VerticalStackLayout>
            </HorizontalStackLayout>
            <controls:IconTextButton Grid.Column="1"
                                     Text="{x:Static strings:AppResources.SourcesButton}"
                                     ImageSource="icon_sources.svg"
                                     Command="{Binding OpenSourcesCommand}" />
            <Button Grid.Column="2"
                    Text="{x:Static strings:AppResources.SettingsButton}"
                    Command="{Binding OpenSettingsCommand}"
                    Margin="8,0,0,0" />
            <controls:IconTextButton Grid.Column="3"
                                     Text="{x:Static strings:AppResources.ReindexButton}"
                                     ImageSource="icon_reindex.svg"
                                     Command="{Binding RunIndexCommand}"
                                     Margin="8,0,0,0" />
        </Grid>

        <!-- Hero -->
        <Grid Grid.Row="1" Padding="16,12" BackgroundColor="{DynamicResource AppBg}">
            <Frame CornerRadius="20"
                   Padding="16"
                   BorderColor="{DynamicResource BorderSubtle}">
                <Frame.Background>
                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                        <GradientStop Color="{DynamicResource Surface2}" Offset="0.0" />
                        <GradientStop Color="{DynamicResource AccentGlow}" Offset="0.6" />
                        <GradientStop Color="{DynamicResource Surface3}" Offset="1.0" />
                    </LinearGradientBrush>
                </Frame.Background>
                <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                    <VerticalStackLayout Spacing="8">
                        <Label Text="{x:Static strings:AppResources.HeroEyebrow}"
                               FontSize="12"
                               TextColor="{DynamicResource OnSurfaceMuted}" />
                        <Label Text="{x:Static strings:AppResources.HeroTitle}"
                               FontSize="22"
                               FontAttributes="Bold"
                               TextColor="{DynamicResource OnSurface}" />
                        <Label Text="{x:Static strings:AppResources.HeroSubtitle}"
                               FontSize="13"
                               TextColor="{DynamicResource OnSurfaceMuted}" />
                        <HorizontalStackLayout Spacing="8">
                            <Frame BackgroundColor="{DynamicResource Surface3}"
                                   CornerRadius="999"
                                   Padding="10,4"
                                   BorderColor="{DynamicResource BorderSubtle}">
                                <HorizontalStackLayout Spacing="6">
                                    <Image Source="chip_collection.svg" HeightRequest="14" WidthRequest="14" />
                                    <Label Text="{x:Static strings:AppResources.SourcesButton}"
                                           FontSize="11"
                                           TextColor="{DynamicResource OnSurfaceMuted}" />
                                </HorizontalStackLayout>
                            </Frame>
                            <Frame BackgroundColor="{DynamicResource Surface3}"
                                   CornerRadius="999"
                                   Padding="10,4"
                                   BorderColor="{DynamicResource BorderSubtle}">
                                <HorizontalStackLayout Spacing="6">
                                    <Image Source="chip_spark.svg" HeightRequest="14" WidthRequest="14" />
                                    <Label Text="{x:Static strings:AppResources.SortTitle}"
                                           FontSize="11"
                                           TextColor="{DynamicResource OnSurfaceMuted}" />
                                </HorizontalStackLayout>
                            </Frame>
                        </HorizontalStackLayout>
                    </VerticalStackLayout>
                    <Image Grid.Column="1"
                           Source="hero_video.svg"
                           HeightRequest="120"
                           WidthRequest="140"
                           HorizontalOptions="End"
                           VerticalOptions="Center" />
                </Grid>
            </Frame>
        </Grid>

        <!-- Highlights -->
        <Grid Grid.Row="2" Padding="16,0,16,12" RowDefinitions="Auto,Auto" RowSpacing="10">
            <Label Text="{x:Static strings:AppResources.HighlightsTitle}"
                   FontAttributes="Bold"
                   FontSize="14"
                   TextColor="{DynamicResource OnSurface}" />
            <Grid Grid.Row="1" ColumnDefinitions="*,*,*" ColumnSpacing="12">
                <Frame BackgroundColor="{DynamicResource Surface}"
                       CornerRadius="16"
                       Padding="12"
                       BorderColor="{DynamicResource BorderSubtle}">
                    <VerticalStackLayout Spacing="6">
                        <Image Source="icon_play.svg" HeightRequest="18" WidthRequest="18" />
                        <Label Text="{Binding VideoCount}"
                               FontSize="20"
                               FontAttributes="Bold"
                               TextColor="{DynamicResource OnSurface}" />
                        <Label Text="{x:Static strings:AppResources.HighlightsVideosLabel}"
                               FontSize="12"
                               TextColor="{DynamicResource OnSurfaceMuted}" />
                    </VerticalStackLayout>
                </Frame>
                <Frame Grid.Column="1"
                       BackgroundColor="{DynamicResource Surface}"
                       CornerRadius="16"
                       Padding="12"
                       BorderColor="{DynamicResource BorderSubtle}">
                    <VerticalStackLayout Spacing="6">
                        <Image Source="icon_sources.svg" HeightRequest="18" WidthRequest="18" />
                        <Label Text="{Binding EnabledSourceCount}"
                               FontSize="20"
                               FontAttributes="Bold"
                               TextColor="{DynamicResource OnSurface}" />
                        <Label Text="{x:Static strings:AppResources.HighlightsSourcesLabel}"
                               FontSize="12"
                               TextColor="{DynamicResource OnSurfaceMuted}" />
                        <Label Text="{Binding SourcesSummary}"
                               FontSize="11"
                               TextColor="{DynamicResource OnSurfaceMuted}" />
                    </VerticalStackLayout>
                </Frame>
                <Frame Grid.Column="2"
                       BackgroundColor="{DynamicResource Surface}"
                       CornerRadius="16"
                       Padding="12"
                       BorderColor="{DynamicResource BorderSubtle}">
                    <VerticalStackLayout Spacing="6">
                        <Image Source="chip_spark.svg" HeightRequest="18" WidthRequest="18" />
                        <Label Text="{x:Static strings:AppResources.HighlightsTipLabel}"
                               FontSize="13"
                               FontAttributes="Bold"
                               TextColor="{DynamicResource OnSurface}" />
                        <Label Text="{x:Static strings:AppResources.HighlightsTipText}"
                               FontSize="11"
                               TextColor="{DynamicResource OnSurfaceMuted}" />
                    </VerticalStackLayout>
                </Frame>
            </Grid>
        </Grid>

        <!-- Permission notice -->
        <Grid Grid.Row="3"
              Padding="12"
              IsVisible="{Binding HasMediaPermission, Converter={StaticResource InverseBoolConverter}}">
            <Frame BackgroundColor="{DynamicResource Surface}"
                   CornerRadius="12"
                   Padding="12"
                   HasShadow="False">
                <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                    <VerticalStackLayout Spacing="4">
                        <Label Text="{x:Static strings:AppResources.PermissionTitle}"
                               FontAttributes="Bold"
                               TextColor="{DynamicResource OnSurface}" />
                        <Label Text="{x:Static strings:AppResources.PermissionMessage}"
                               TextColor="{DynamicResource OnSurfaceMuted}"
                               FontSize="12" />
                    </VerticalStackLayout>
                    <Button Grid.Column="1"
                            Text="{x:Static strings:AppResources.PermissionOk}"
                            Command="{Binding RequestPermissionCommand}" />
                </Grid>
            </Frame>
        </Grid>

        <!-- Search + Sort -->
        <Grid Grid.Row="4" Padding="12" ColumnDefinitions="*,Auto" BackgroundColor="{DynamicResource AppBg}">
            <SearchBar Placeholder="{x:Static strings:AppResources.SearchPlaceholder}"
                       Text="{Binding SearchText}"
                       SearchCommand="{Binding RefreshCommand}"
                       BackgroundColor="{DynamicResource Surface2}"
                       TextColor="{DynamicResource OnSurface}"
                       PlaceholderColor="{DynamicResource OnSurfaceMuted}" />
            <Picker Grid.Column="1"
                    ItemsSource="{Binding SortOptions}"
                    ItemDisplayBinding="{Binding Display}"
                    SelectedItem="{Binding SelectedSortOption}"
                    Title="{x:Static strings:AppResources.SortTitle}"
                    TextColor="{DynamicResource OnSurface}"
                    BackgroundColor="{DynamicResource Surface2}"
                    Margin="8,0,0,0" />
        </Grid>

        <!-- Grid -->
        <Grid Grid.Row="5" x:Name="BrowserGrid" ColumnDefinitions="*,96">
            <VisualStateManager.VisualStateGroups>
                <VisualStateGroup x:Name="LayoutStates">
                    <VisualState x:Name="Phone">
                        <VisualState.StateTriggers>
                            <OnIdiom x:TypeArguments="StateTriggerBase">
                                <OnIdiom.Phone>
                                    <StateTrigger IsActive="True" />
                                </OnIdiom.Phone>
                                <OnIdiom.Default>
                                    <StateTrigger IsActive="False" />
                                </OnIdiom.Default>
                            </OnIdiom>
                        </VisualState.StateTriggers>
                        <VisualState.Setters>
                            <Setter TargetName="BrowserGrid" Property="ColumnDefinitions" Value="*" />
                            <Setter TargetName="BrowserGrid" Property="RowDefinitions" Value="Auto,*" />
                            <Setter TargetName="TimelineView" Property="Grid.Row" Value="0" />
                            <Setter TargetName="TimelineView" Property="Grid.Column" Value="0" />
                            <Setter TargetName="TimelineView" Property="Margin" Value="12,0,12,8" />
                            <Setter TargetName="VideosView" Property="Grid.Row" Value="1" />
                            <Setter TargetName="VideosView" Property="Grid.Column" Value="0" />
                        </VisualState.Setters>
                    </VisualState>
                    <VisualState x:Name="Wide">
                        <VisualState.StateTriggers>
                            <OnIdiom x:TypeArguments="StateTriggerBase">
                                <OnIdiom.Tablet>
                                    <StateTrigger IsActive="True" />
                                </OnIdiom.Tablet>
                                <OnIdiom.Desktop>
                                    <StateTrigger IsActive="True" />
                                </OnIdiom.Desktop>
                                <OnIdiom.TV>
                                    <StateTrigger IsActive="True" />
                                </OnIdiom.TV>
                                <OnIdiom.Default>
                                    <StateTrigger IsActive="False" />
                                </OnIdiom.Default>
                            </OnIdiom>
                        </VisualState.StateTriggers>
                        <VisualState.Setters>
                            <Setter TargetName="BrowserGrid" Property="ColumnDefinitions" Value="*,96" />
                            <Setter TargetName="BrowserGrid" Property="RowDefinitions" Value="*" />
                            <Setter TargetName="TimelineView" Property="Grid.Row" Value="0" />
                            <Setter TargetName="TimelineView" Property="Grid.Column" Value="1" />
                            <Setter TargetName="TimelineView" Property="Margin" Value="8,0,8,0" />
                            <Setter TargetName="VideosView" Property="Grid.Row" Value="0" />
                            <Setter TargetName="VideosView" Property="Grid.Column" Value="0" />
                        </VisualState.Setters>
                    </VisualState>
                </VisualStateGroup>
            </VisualStateManager.VisualStateGroups>
            <CollectionView ItemsSource="{Binding TimelineEntries}"
                            x:Name="TimelineView"
                            SelectionMode="Single"
                            SelectionChanged="OnTimelineSelectionChanged"
                            BackgroundColor="{DynamicResource AppBg}"
                            VerticalScrollBarVisibility="Always"
                            Margin="8,0,8,0"
                            Grid.Column="1">
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Vertical" ItemSpacing="8" />
                </CollectionView.ItemsLayout>
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Grid ColumnDefinitions="14,*" RowDefinitions="Auto,Auto" Padding="4,6">
                            <BoxView Grid.RowSpan="2"
                                     WidthRequest="2"
                                     BackgroundColor="{DynamicResource BorderSubtle}"
                                     HorizontalOptions="Center"
                                     VerticalOptions="Fill" />
                            <Frame Grid.Column="1"
                                   Grid.RowSpan="2"
                                   Padding="8,6"
                                   CornerRadius="12"
                                   BackgroundColor="{DynamicResource Surface2}"
                                   BorderColor="{DynamicResource BorderSubtle}"
                                   HasShadow="False">
                                <VerticalStackLayout Spacing="2">
                                    <Label Text="{Binding MonthLabel}"
                                           FontAttributes="Bold"
                                           FontSize="12"
                                           TextColor="{DynamicResource OnSurface}" />
                                    <Label Text="{Binding YearLabel}"
                                           FontSize="10"
                                           TextColor="{DynamicResource OnSurfaceMuted}"
                                           IsVisible="{Binding ShowYear}" />
                                </VerticalStackLayout>
                            </Frame>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <CollectionView Grid.Column="0"
                            ItemsSource="{Binding Videos}"
                            x:Name="VideosView"
                            SelectionMode="None"
                            VerticalScrollBarVisibility="Always">
                <CollectionView.ItemsLayout>
                    <GridItemsLayout Orientation="Vertical" Span="{Binding GridSpan}" />
                </CollectionView.ItemsLayout>

                <CollectionView.EmptyView>
                    <VerticalStackLayout Spacing="12"
                                         HorizontalOptions="Center"
                                         VerticalOptions="Center"
                                         Margin="24">
                        <Image Source="empty_state.svg"
                               HeightRequest="180"
                               WidthRequest="240"
                               HorizontalOptions="Center" />
                        <Label Text="{x:Static strings:AppResources.EmptyStateTitle}"
                               FontAttributes="Bold"
                               FontSize="16"
                               TextColor="{DynamicResource OnSurface}"
                               HorizontalTextAlignment="Center" />
                        <Label Text="{x:Static strings:AppResources.EmptyStateMessage}"
                               FontSize="13"
                               TextColor="{DynamicResource OnSurfaceMuted}"
                               HorizontalTextAlignment="Center" />
                        <Button Text="{x:Static strings:AppResources.EmptyStateAction}"
                                Command="{Binding OpenSourcesCommand}" />
                    </VerticalStackLayout>
                </CollectionView.EmptyView>

                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame BackgroundColor="{DynamicResource Surface}"
                               CornerRadius="16"
                               Margin="8"
                               Padding="0"
                               BorderColor="{DynamicResource BorderSubtle}">
                            <Frame.ContextFlyout>
                                <MenuFlyout>
                                    <MenuFlyoutItem Text="{x:Static strings:AppResources.ShareAction}"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ShareCommand}"
                                                    CommandParameter="{Binding .}">
                                        <MenuFlyoutItem.IsVisible>
                                            <OnPlatform x:TypeArguments="x:Boolean">
                                                <On Platform="Android" Value="True" />
                                                <On Platform="Windows" Value="False" />
                                            </OnPlatform>
                                        </MenuFlyoutItem.IsVisible>
                                    </MenuFlyoutItem>
                                    <MenuFlyoutItem Text="{x:Static strings:AppResources.SaveAsAction}"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SaveAsCommand}"
                                                    CommandParameter="{Binding .}">
                                        <MenuFlyoutItem.IsVisible>
                                            <OnPlatform x:TypeArguments="x:Boolean">
                                                <On Platform="Android" Value="False" />
                                                <On Platform="Windows" Value="True" />
                                            </OnPlatform>
                                        </MenuFlyoutItem.IsVisible>
                                    </MenuFlyoutItem>
                                </MenuFlyout>
                            </Frame.ContextFlyout>
                            <Grid RowDefinitions="170,Auto,Auto,Auto" Padding="10">
                                <Grid RowDefinitions="*" BackgroundColor="{DynamicResource Surface2}"
                                      HeightRequest="170">
                                    <Image
                                        Source="{Binding ThumbnailPath, Converter={StaticResource StringFallbackConverter}, ConverterParameter=video_placeholder.svg}"
                                        Aspect="AspectFill" />
                                    <Frame BackgroundColor="#CC0E0F14"
                                           CornerRadius="999"
                                           Padding="6"
                                           HorizontalOptions="End"
                                           VerticalOptions="End"
                                           Margin="8">
                                        <Image Source="icon_play.svg" HeightRequest="16" WidthRequest="16" />
                                    </Frame>
                                </Grid>

                                <Label Grid.Row="1"
                                       Text="{Binding Name}"
                                       TextColor="{DynamicResource OnSurface}"
                                       FontSize="13"
                                       LineBreakMode="TailTruncation"
                                       Margin="0,10,0,0" />

                                <Frame Grid.Row="2"
                                       BackgroundColor="{DynamicResource Surface2}"
                                       BorderColor="{DynamicResource BorderSubtle}"
                                       CornerRadius="8"
                                       Padding="8,4"
                                       HorizontalOptions="Start"
                                       Margin="0,6,0,2">
                                    <HorizontalStackLayout Spacing="6">
                                        <Image Source="chip_clock.svg" HeightRequest="12" WidthRequest="12" />
                                        <Label Text="{Binding DurationText}"
                                               TextColor="{DynamicResource OnSurfaceMuted}"
                                               FontSize="11" />
                                    </HorizontalStackLayout>
                                </Frame>

                                <ImageButton Grid.Row="3"
                                             Source="icon_play.svg"
                                             Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.PlayCommand}"
                                             CommandParameter="{Binding .}"
                                             Margin="0,4,0,8"
                                             HeightRequest="40"
                                             WidthRequest="40"
                                             HorizontalOptions="Start"
                                             VerticalOptions="Center" />

                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.PlayCommand}"
                                        CommandParameter="{Binding .}" />
                                </Grid.GestureRecognizers>
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- Indexing banner -->
            <Frame Grid.ColumnSpan="2"
                   IsVisible="{Binding ShowIndexingBanner}"
                   BackgroundColor="{DynamicResource Surface}"
                   CornerRadius="12"
                   BorderColor="{DynamicResource BorderSubtle}"
                   Padding="12"
                   HorizontalOptions="Center"
                   VerticalOptions="Start"
                   Margin="16,12"
                   HasShadow="False">
                <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto" ColumnDefinitions="*,Auto" ColumnSpacing="12">
                    <Label Text="{x:Static strings:AppResources.Indexing}"
                           FontAttributes="Bold"
                           TextColor="{DynamicResource OnSurface}" />
                    <Button Grid.Column="1"
                            Text="{x:Static strings:AppResources.IndexingShowDetailsButton}"
                            Command="{Binding ShowIndexOverlayCommand}" />
                    <Label Grid.Row="1"
                           Grid.ColumnSpan="2"
                           Text="{Binding IndexStatus}"
                           FontSize="12"
                           TextColor="{DynamicResource OnSurfaceMuted}" />
                    <Label Grid.Row="2"
                           Grid.ColumnSpan="2"
                           Text="{Binding IndexCurrentFolder, StringFormat={x:Static strings:AppResources.IndexingFolderFormat}}"
                           FontSize="11"
                           TextColor="{DynamicResource OnSurfaceMuted}" />
                    <Label Grid.Row="3"
                           Grid.ColumnSpan="2"
                           Text="{Binding IndexCurrentFile, StringFormat={x:Static strings:AppResources.IndexingFileFormat}}"
                           FontSize="11"
                           TextColor="{DynamicResource OnSurfaceMuted}" />
                    <ProgressBar Grid.Row="4"
                                 Grid.ColumnSpan="2"
                                 Progress="{Binding IndexRatio}" />
                </Grid>
            </Frame>

            <!-- Indexing overlay -->
            <Grid Grid.ColumnSpan="2"
                  IsVisible="{Binding IsIndexingOverlayVisible}"
                  BackgroundColor="#99000000"
                  Padding="24">
                <Frame BackgroundColor="{DynamicResource Surface}"
                       CornerRadius="16"
                       Padding="16"
                       HorizontalOptions="Center"
                       VerticalOptions="Center"
                       HasShadow="False">
                    <VerticalStackLayout Spacing="10">
                        <Label Text="{x:Static strings:AppResources.Indexing}"
                               FontAttributes="Bold"
                               TextColor="{DynamicResource OnSurface}" />
                        <Label Text="{Binding IndexStatus}"
                               TextColor="{DynamicResource OnSurfaceMuted}" />
                        <Label Text="{Binding IndexCurrentFolder, StringFormat={x:Static strings:AppResources.IndexingFolderFormat}}"
                               TextColor="{DynamicResource OnSurfaceMuted}"
                               FontSize="12" />
                        <Label Text="{Binding IndexCurrentFile, StringFormat={x:Static strings:AppResources.IndexingFileFormat}}"
                               TextColor="{DynamicResource OnSurfaceMuted}"
                               FontSize="12" />
                        <Label
                            Text="{Binding IndexedCount, StringFormat={x:Static strings:AppResources.NewItemsFormat}}"
                            TextColor="{DynamicResource OnSurfaceMuted}" />
                        <ProgressBar Progress="{Binding IndexRatio}" />
                        <Button Text="{x:Static strings:AppResources.IndexingBackgroundButton}"
                                Command="{Binding DismissIndexOverlayCommand}" />
                    </VerticalStackLayout>
                </Frame>
            </Grid>
        </Grid>
    </Grid>
</ContentPage>
